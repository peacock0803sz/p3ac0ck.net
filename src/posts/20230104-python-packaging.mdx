---
slug: 20230104-python-packaging
title: "ãã®Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã€venv + pipã§ã‚ˆããªã„ã§ã™ã‹? in 2023/1"
lang: ja
emoji: "ğŸ“¦"
pubDate: 2023-01-04
---

import Note from "../components/Note.astro";

# ç›®æ¬¡

# å‹•æ©Ÿ

å„æ‰€(ä¸»ã«Pythonç•Œéšˆã®å¤–)ã§ã€ŒPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã©ã†ã™ã‚‹ã®ãŒæ­£è§£ãªã®?ã€ã¨ã‚ˆãè€³ã«ã™ã‚‹ã®ã§2023å¹´åˆé ­æ™‚ç‚¹ã§ã®ç§ã®è¦‹è§£ã‚’æ›¸ãã¾ã™ã€‚

<Note>
ã“ã®è¨˜äº‹ã¯venv + pipä»¥å¤–ã®ãƒ„ãƒ¼ãƒ«(ç‰¹ã«[`poetry`](https://python-poetry.org/), [`pipenv`](https://github.com/pypa/pipenv), [`pip-tools`](https://github.com/jazzband/pip-tools)ã¸ã®ã‚¢ãƒ³ãƒãƒ†ãƒ¼ã‚¼è¦ç´ ã‚’å¤šåˆ†ã«å«ã¿ã¾ã™ã€‚
ç§ã¯ã„ã‚ã‚†ã‚‹ã€Œvenvã§ã‚ˆããªã„ã§ã™ã‹? ãŠã˜ã•ã‚“ã€ã‚’ã‚ˆãã‚„ã‚‹ã®ã§ãã‚Œã®ã¾ã¨ã‚ã ã¨æ€ã£ã¦é ‚ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚
</Note>

# tl;dr

å¤šãã®å ´åˆã®Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã¯venv(virtualenv) + pipã§æ¸ˆã‚€ã®ã§ã¯?

# å‰æ

ã‚¿ã‚¤ãƒˆãƒ«ã«`venv`ã¨ã¤ã„ã¦ã„ã¾ã™ãŒã€ä»¥é™venv(virtualenv)ã«ã¤ã„ã¦ã¯è¨€åŠã—ã¾ã›ã‚“ã€‚ä»®æƒ³ç’°å¢ƒå†…ã§ä½œæ¥­ã—ã¦ã„ã‚‹å‰æã§è©±ã‚’é€²ã‚ã¾ã™ã€‚
ã“ã®è¨˜äº‹ã§ã¯åŸºæœ¬çš„ã«`setup.py` / `setup.cfg`ã§ã¯ãªã`pyproject.toml`ã§ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å®šç¾©æ–¹æ³•ã‚’æ¡ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã¯[PEP 621](https://peps.python.org/pep-0621/)ãŒã“ã“æœ€è¿‘ã§æ¡æŠãƒ»å®Ÿè£…ã•ã‚ŒãŸãŸã‚ã§ã™ã€‚


ãªãŠã€æƒ³å®šã—ã¦ã„ã‚‹Pythonã‚„å„ãƒ„ãƒ¼ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- Python >= 3.8
- pip >= 23.1
- setuptools >= 45

## ç”¨èª

- [PEP](https://peps.python.org): Python Enhancement Proposalsã®ç•¥ã€‚æ–°æ©Ÿèƒ½ã‚„æ”¹å–„æ¡ˆãªã©ãŒæå‡ºã•ã‚Œé›†ã‚ã‚‰ã‚ŒãŸã‚‚ã®
- [Setuptools](https://setuptools.pypa.io/en/latest/index.html): pip(ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼)ãŒãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦ä½¿ãˆã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®1ã¤

<details>
<summary>èª¤è¨˜ã‚’ä¿®æ­£</summary>
https://twitter.com/aodag/status/1610607294643073024
</details>

- Absolute Import: çµ¶å¯¾ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨ã‚‚è¨€ã‚ã‚Œã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã‹ã‚‰ã®çµ¶å¯¾ãƒ‘ã‚¹ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹æ›¸ãæ–¹

# åŸºæœ¬ã®æ§‹æˆã® `pyproject.toml`

```toml
[build-system]
requires = ["setuptools>=45", "wheel"]

[project]
name = "my-awesome-package"
readme = "README.md"
license = {file = "LICENSE"}
authors = [{name = "Peacock", email = "peacock@example.com"}]
urls = {repository = "https://github.com/peacock0803sz/my-awesome-package"}

dynamic = ["version"]
requires-python = ">=3.8"

dependencies = [
  ""  # ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã“ã“ã«æ›¸ã
]

[project.optional-dependencies]
test = ["pytest"]  # ä»–ãƒ†ã‚¹ãƒˆã«å¿…è¦ãªã‚‚ã®(freezegunã¨ã‹)ãªã©
dev = ["black", "flake8", "mypy"]

# mypy / blackã®è¨­å®šãªã©
```

ã“ã®æ›¸ãæ–¹ã¯ã“ã®å¾Œã®4.ä»¥å¤–ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãªã‚‰ã°ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è‡ªå‹•æ¤œå‡ºã—ã¦ãã‚Œã¾ã™ã€‚

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ & `pyproject.toml`ä¾‹ã„ã‚ã„ã‚

`.git` ãŒã‚ã‚‹Repository Rootæƒ³å®šã‹ã‚‰ã®æ§‹é€ ã¨`package_dir`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ›¸ãæ–¹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
ãªãŠã€ä»¥ä¸‹ç‰¹ç­†ã—ãªã„é™ã‚Š`pip install --editable`ã§Editable Installã—ã€è‡ªåˆ†è‡ªèº«ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å(`my_awesome_package`)ã‚’Absolute ImportãŒã§ãã‚‹ã‚ˆã†ã«æ›¸ã„ã¦ã„ã¾ã™ã€‚

## 1. `snake_case` ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç›´ä¸‹ã«ç½®ãã‚¿ã‚¤ãƒ—

èª¬æ˜ä¸è¦ãªæ°—ã‚‚ã—ã¾ã™ãŒã€`from my_awesome_package import ...`ã®ã‚ˆã†ã«Absolute Importã§ãã¾ã™ã€‚

```
.
â”œâ”€â”€ LICENSE / README.md etc ...
â”œâ”€â”€ my_awesome_package
â”‚  â”œâ”€â”€ __init__.py
â”‚  â””â”€â”€ main.py
â”œâ”€â”€ tests
â”‚  â”œâ”€â”€ conftest.py
â”‚  â””â”€â”€ test_main.py
â”œâ”€â”€ pyproject.toml
â””â”€â”€ setup.cfg
```

## 2. `src/` ã‚’ä¸€åº¦åˆ‡ã£ã¦ãã®ä¸‹ã«1ã¤ä»¥ä¸Šã®ã‚µãƒ–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç½®ãã‚¿ã‚¤ãƒ—

```
.
â”œâ”€â”€ LICENSE / README.md etc ...
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ setup.cfg
â””â”€â”€ src
   â”œâ”€â”€ core
   â”‚  â”œâ”€â”€ __init__.py
   â”‚  â””â”€â”€ main.py
   â”œâ”€â”€ misc
   â”‚  â”œâ”€â”€ __init__.py
   â”‚  â””â”€â”€ main.py
   â””â”€â”€ tests
      â”œâ”€â”€ conftest.py
      â””â”€â”€ core
         â””â”€â”€ test_main.py
```

ã“ã®å ´åˆã§è‡ªåˆ†ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸(`my_awesome_package`)ã«å¯¾ã—ã¦Absolute Importã‚’è¡Œã„ãŸã„å ´åˆã¯`pyproject.toml`ã«æ¬¡ã®è¨˜è¼‰ãŒå¿…è¦ã§ã™[^1]

```toml
 ...
[tool.setuptools.package-dir]
my_awesome_package = "src"
"_" = "src/tests"  # src/testsé…ä¸‹ã‚’é™¤å¤–ã™ã‚‹ãŸã‚ã®ãƒãƒƒã‚¯
 ...
```

## 3. `snake_case` ã§1ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã§æ¸ˆã¾ã›ã‚‹ã‚¿ã‚¤ãƒ—

Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®bottleã®å½¢ã§ã™ã€‚

```
.
â”œâ”€â”€ LICENSE / README.md etc ...
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ setup.cfg
â”œâ”€â”€ my_awesome_package.py
â””â”€â”€ tests
   â”œâ”€â”€ conftest.py
   â””â”€â”€ test_main.py
```

## 4. `.` åŒºåˆ‡ã‚Šã§åå‰ç©ºé–“ã‚’åˆ‡ã£ã¦ã„ããŸã„ã‚¿ã‚¤ãƒ—

ä¸€ç•ªç‰¹æ®Šã€‚Zope/Ploneã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã“ã‚Œã§ã™ã€‚
ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯`src/my/__init__.py`(Package Rootã®`__init__.py`)ã§å°‘ã—ç´°å·¥ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸãŒã€[PEP 420](https://peps.python.org/pep-0420/)ã®æ¡æŠãƒ»å®Ÿè£…ã«ã‚ˆã‚Šä¸è¦ã«ãªã‚Šã¾ã—ãŸã€‚[^2]
(å¼•ãç¶šãAbsolute Importã®ãŸã‚ã«`pyproject.toml`ã«ã¯æ‰‹ã‚’åŠ ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚)
ã¾ãšãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```
.
â”œâ”€â”€ LICENSE / README.md etc ...
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ setup.cfg
â””â”€â”€ src
   â”œâ”€â”€ my
   â”‚  â””â”€â”€ awesome
   â”‚     â””â”€â”€ package
   â”‚        â”œâ”€â”€ __init__.py
   â”‚        â””â”€â”€ main.py
   â””â”€â”€ tests
      â”œâ”€â”€ conftest.py
      â””â”€â”€ test_main.py
```

åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰`pyproject.toml`ã«ã“ã‚Œã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```toml
 ...
[tool.setuptools.packages.find]
where = ["src"]
exclude = ["tests"]  # testsã‚’srcã®ä¸‹ã«ç½®ãå ´åˆ
namespaces = false
 ...
```

ã“ã†ã™ã‚‹ã“ã¨ã§`from my.awesome.package import ...`ã¨ã™ã‚‹Absolute ImportãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

# ã‚ãªãŸãŒã‚„ã‚ŠãŸã„ã¨æ€ã£ã¦ã„ã‚‹ã“ã¨ã€ã»ã¼å‡ºæ¥ã¾ã™ã‚ˆ

## é–‹ç™ºç”¨ã«ã ã‘ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æŒ‡å®š

`Pipfile`(pipenv)ã®`[dev-packages]`, poetry(`pyproject.toml`)ã®`[tool.poetry.group.*.dependencies]`ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ãŒã“ã‚Œã§ã™ã€‚é–‹ç™ºæ™‚ã®ã¿ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãªã©ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚
pip installã®`-c`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨åˆã‚ã›ã¦ä½¿ã†ã¨ä¾¿åˆ©ã§ã™ã€‚[^3]
æœ€åˆã«æŒ™ã’ãŸä¾‹ã«ã‚‚æ›¸ã„ã¦ã„ã¾ã™ãŒã€ã“ã®ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚

```toml
[project.optional-dependencies]
test = ["pytest"]  # ä»–ãƒ†ã‚¹ãƒˆã«å¿…è¦ãªã‚‚ã®(freezegunã¨ã‹)ãªã©
dev = ["black", "flake8", "mypy"]
```
åå‰(ã‚­ãƒ¼)ã«ä½¿ãˆã‚‹æ–‡å­—ã¯[PEP 685](https://peps.python.org/pep-0685/)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼(npm scripts)çš„ãªã‚‚ã®

`pyproject.toml`ã«æ¬¡ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹ã“ã¨ã§ã€ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼ã®ã‚ˆã†ãªã“ã¨ã‚‚ã§ãã¾ã™ã€‚[^4]
~~ã“ã“ã§æœ«å°¾ã«`[dev]`ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹ã“ã¨ã§å¿…è¦ãªextras(ä¸Šè¿°ã®`project.optional-dependences`)ã‚’æ˜è¨˜ã§ãã¾ã™ã€‚~~
~~ã‚‚ã¡ã‚ã‚“~~ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚‚ã®ã‚’æŒ‡å®šã—ã¦ã‚‚å•é¡Œãªã„ã§ã™ã€‚

:::details 2023/01/05 æ‰“ã¡æ¶ˆã—ç·šã‚’è¿½åŠ 
https://twitter.com/aodag/status/1610589178798174208
:::

```toml
[project.scripts]
my_awesome_cmd = "some_package.module:func"
dev_cmd = "some_package.module:dev_func [dev]"  # extrasã‚’æŒ‡å®šã™ã‚‹å ´åˆ
```

# æ®‹å¿µãªãŒã‚‰å‡ºæ¥ãªã„ã“ã¨

ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ãã«`pyproject.toml` / `constraints.txt`ã‚’è‡ªå‹•æ›´æ–°ã—ãŸã‚Šå­ã‚„å­«ã®ä¾å­˜ã‚‚å‰Šé™¤ã™ã‚‹ãªã©ã®æ©Ÿèƒ½ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ä»•äº‹ã®é–‹ç™ºã§ä½¿ã£ã¦ã„ã‚‹ã¨è‹¥å¹²ã¤ã‚‰ã„ã§ã™ãŒã€ã‚ã¾ã‚Šä½¿ã‚ãªã„ã®ã§ã€ç­†è€…ã¯ã“ã‚Œã‚’ç†ç”±ã«poetryã‚’ä½¿ã†ãªã©ã¯è€ƒãˆã¾ã›ã‚“ã§ã—ãŸã€‚

# References (å‚è€ƒè³‡æ–™)

å…¨ã¦è‹±èªã§ã™ãŒã€åŸ·ç­†ã«ã‚ãŸã‚Šå‚ç…§ã—ãŸè¨˜äº‹ã‚„ãƒšãƒ¼ã‚¸ã‚’åˆ—æŒ™ã—ã¦ãŠãã¾ã™ã€‚

- [Package Discovery and Namespace Packages](https://setuptools.pypa.io/en/latest/userguide/package_discovery.html)
   - Setuptoolså…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ¤œç´¢ã¨åå‰ç©ºé–“ã«ã¤ã„ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ‰
- [Declaring project metadata - Python Packaging User Guide](https://packaging.python.org/en/latest/specifications/declaring-project-metadata/)
   - PEP 621ã®æ¡æŠãƒ»å®Ÿè£…ã‚’ã†ã‘ã¦æ›¸ã‹ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚¬ã‚¤ãƒ‰
- [peacock0803sz/python-template](https://github.com/peacock0803sz/python-template)
   - æ‹™ä½œã®Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒª(ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æœ¬ä½“ã¯æ›¸ã„ã¦ã„ãªã„)

[^1]: æ®‹å¿µãªãŒã‚‰LSP(pyright / pylance)ã®èª­ã¿è¾¼ã¿å¯èƒ½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¯å‡ºã¦ã“ãªã„ã‚ˆã†ã§ã™ã€‚ã‚‚ã£ã¨è‰¯ã„æ–¹æ³•ãŒã‚ã£ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆç­‰ã§æ•™ãˆã¦ãã ã•ã„ã€‚
[^2]: https://setuptools.pypa.io/en/latest/userguide/package_discovery.html#legacy-namespace-packages
[^3]: https://zenn.dev/peacock0803sz/articles/acd723d5a5fa0b(æ‹™ä½œå‚è€ƒè¨˜äº‹)
[^4]: https://packaging.python.org/en/latest/specifications/declaring-project-metadata/#entry-points
